<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>¬°TU AVENTURA!</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            /* DEFAULTS (Space) */
            --bg-color: #0B1026;
            --bg-gradient: linear-gradient(135deg, #0B1026 0%, #2B32B2 100%);
            --primary: #F72585;
            --secondary: #4CC9F0;
            --accent: #FFD93D;
            --glass: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-main: #FFFFFF;
            --success: #2ECC71;

            --icon-circle-bg: rgba(255, 255, 255, 0.1);
            --font-main: 'Nunito', sans-serif;
            --font-head: 'Fredoka One', cursive;
        }

        /* üöÄ THEME: SPACE */
        body.theme-space {
            --bg-gradient: linear-gradient(135deg, #0B1026 0%, #2B32B2 100%);
            --primary: #F72585;
            --secondary: #4CC9F0;
            --accent: #FFD93D;
        }

        body.theme-space .bg-overlay {
            background-image:
                radial-gradient(2px 2px at 20px 30px, #eee, rgba(0, 0, 0, 0)),
                radial-gradient(2px 2px at 40px 70px, #fff, rgba(0, 0, 0, 0)),
                radial-gradient(2px 2px at 90px 40px, #fff, rgba(0, 0, 0, 0));
            background-size: 200px 200px;
            animation: twinkle 5s infinite;
        }

        /* üå≤ THEME: FOREST */
        body.theme-forest {
            --bg-gradient: linear-gradient(135deg, #1b5e20 0%, #81c784 100%);
            --primary: #FF7043;
            --secondary: #4DB6AC;
            --accent: #FFD54F;
            --glass: rgba(255, 255, 255, 0.2);
            --glass-border: rgba(255, 255, 255, 0.3);
        }

        body.theme-forest .bg-overlay {
            background-image: url('data:image/svg+xml;utf8,<svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg"><path d="M20 5 L10 25 H30 Z" fill="rgba(255,255,255,0.1)"/></svg>');
            background-size: 60px 60px;
        }

        /* üè¥‚Äç‚ò†Ô∏è THEME: PIRATE */
        body.theme-pirate {
            --bg-gradient: linear-gradient(135deg, #1a237e 0%, #00acc1 100%);
            --primary: #d32f2f;
            --secondary: #ffd700;
            --accent: #ffeb3b;
            --glass: rgba(255, 248, 225, 0.15);
        }

        body.theme-pirate .bg-overlay {
            background-image: url('data:image/svg+xml;utf8,<svg width="60" height="30" viewBox="0 0 60 30" xmlns="http://www.w3.org/2000/svg"><path d="M0 15 Q 15 0 30 15 T 60 15" stroke="rgba(255,255,255,0.1)" fill="none" stroke-width="2"/></svg>');
            background-size: 60px 60px;
            animation: waves 4s infinite linear;
        }

        /* ü¶Å THEME: JUNGLE */
        body.theme-jungle {
            --bg-gradient: linear-gradient(135deg, #004d40 0%, #00bfa5 100%);
            --primary: #ffab00;
            /* Orange tiger */
            --secondary: #64dd17;
            /* Bright Green */
            --accent: #ffd600;
        }

        body.theme-jungle .bg-overlay {
            background-image: url('data:image/svg+xml;utf8,<svg width="50" height="50" viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg"><path d="M25 0 Q 35 25 25 50 Q 15 25 25 0" fill="rgba(255,255,255,0.1)"/></svg>');
            background-size: 50px 50px;
        }

        /* ü¶ï THEME: DINO */
        body.theme-dino {
            --bg-gradient: linear-gradient(135deg, #3e2723 0%, #795548 100%);
            --primary: #ff5722;
            /* Lava */
            --secondary: #8d6e63;
            --accent: #ffcc80;
        }

        body.theme-dino .bg-overlay {
            background-image: url('data:image/svg+xml;utf8,<svg width="60" height="40" viewBox="0 0 60 40" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="30" r="5" fill="rgba(255,255,255,0.1)"/><path d="M30 30 L40 10 L50 30 Z" fill="rgba(255,255,255,0.1)"/></svg>');
            background-size: 80px 80px;
        }

        /* üèéÔ∏è THEME: RACING */
        body.theme-racing {
            --bg-gradient: linear-gradient(135deg, #212121 0%, #424242 100%);
            --primary: #d50000;
            /* Red */
            --secondary: #ffffff;
            --accent: #ffea00;
        }

        body.theme-racing .bg-overlay {
            background-image: url('data:image/svg+xml;utf8,<svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg"><rect x="0" y="0" width="20" height="20" fill="rgba(255,255,255,0.1)"/><rect x="20" y="20" width="20" height="20" fill="rgba(255,255,255,0.1)"/></svg>');
            background-size: 40px 40px;
        }

        /* ü¶∏ THEME: SUPERHERO */
        body.theme-hero {
            --bg-gradient: linear-gradient(135deg, #01579b 0%, #0288d1 100%);
            /* Hero Blue */
            --primary: #d50000;
            /* Hero Red */
            --secondary: #ffeb3b;
            /* Hero Yellow */
            --accent: #ffffff;
        }

        body.theme-hero .bg-overlay {
            background-image: url('data:image/svg+xml;utf8,<svg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"><path d="M30 0 L40 20 L60 20 L45 35 L50 55 L30 40 L10 55 L15 35 L0 20 L20 20 Z" fill="rgba(255,255,255,0.1)"/></svg>');
            background-size: 100px 100px;
            animation: boom 2s infinite alternate;
        }


        /* RESET & BASE */
        * {
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-main);
            background: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text-main);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            transition: background 0.5s ease;
        }

        .bg-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
            opacity: 0.6;
        }

        h1,
        h2,
        h3 {
            font-family: var(--font-head);
            text-transform: uppercase;
            text-align: center;
            margin: 0.5em 0;
            text-shadow: 0 3px 5px rgba(0, 0, 0, 0.3);
        }

        h1.main-title {
            color: var(--accent);
            font-size: 2.2rem;
            margin-top: 10px;
            letter-spacing: 1px;
        }

        /* HEADERS / NAV */
        header {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(5px);
            border-bottom: 1px solid var(--glass-border);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .score-board {
            background: rgba(0, 0, 0, 0.4);
            padding: 8px 25px;
            border-radius: 50px;
            border: 2px solid var(--secondary);
            font-family: var(--font-head);
            font-size: 1.4rem;
            color: var(--secondary);
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        }

        .points-pop {
            position: absolute;
            color: var(--accent);
            font-size: 2.5rem;
            font-weight: 800;
            pointer-events: none;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            animation: fadeUp 0.8s forwards;
            z-index: 999;
        }

        /* SCREENS */
        section.screen {
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            flex: 1;
            animation: fadeIn 0.4s ease;
        }

        section.screen.active {
            display: flex;
        }

        /* SELECTION SCREEN CARDS */
        .adventure-card {
            background: var(--glass);
            border: 3px solid var(--glass-border);
            border-radius: 25px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            width: 100%;
            max-width: 300px;
            margin: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .adventure-card:active {
            transform: scale(0.96);
        }

        .adventure-icon {
            font-size: 3.5rem;
            margin-bottom: 10px;
        }

        .adventure-title {
            font-family: var(--font-head);
            font-size: 1.1rem;
            color: var(--text-main);
        }

        .adventure-desc {
            font-size: 0.8rem;
            opacity: 0.9;
            margin-top: 5px;
            display: block;
        }

        /* Hide desc on grid */

        /* THEME PREVIEWS FOR CARDS */
        .card-space {
            background: linear-gradient(135deg, rgba(11, 16, 38, 0.8), rgba(43, 50, 178, 0.8));
            border-color: #4CC9F0;
        }

        .card-forest {
            background: linear-gradient(135deg, rgba(27, 94, 32, 0.8), rgba(129, 199, 132, 0.8));
            border-color: #4DB6AC;
        }

        .card-pirate {
            background: linear-gradient(135deg, rgba(26, 35, 126, 0.8), rgba(0, 172, 193, 0.8));
            border-color: #FFD700;
        }

        .card-jungle {
            background: linear-gradient(135deg, #004d40, #00bfa5);
            border-color: #ffab00;
        }

        .card-dino {
            background: linear-gradient(135deg, #3e2723, #795548);
            border-color: #ff5722;
        }

        .card-racing {
            background: linear-gradient(135deg, #212121, #424242);
            border-color: #d50000;
        }

        .card-hero {
            background: linear-gradient(135deg, #01579b, #0288d1);
            border-color: #ffeb3b;
        }


        /* CLOTHING GRID & CARDS */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 15px;
            width: 100%;
            padding: 10px;
        }

        .card {
            background: var(--glass);
            border: 2px solid var(--glass-border);
            border-radius: 20px;
            padding: 15px 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            cursor: pointer;
            transition: all 0.2s;
            aspect-ratio: 1;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card:active {
            transform: scale(0.95);
        }

        .card.selected {
            border-color: var(--secondary);
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 15px var(--secondary);
        }

        .card.done {
            background: rgba(46, 204, 113, 0.2);
            border-color: var(--success);
            opacity: 0.7;
            transform: scale(0.98);
        }

        .card.done .card-label {
            text-decoration: line-through;
            color: var(--success);
        }

        .icon-circle {
            background: var(--icon-circle-bg);
            border-radius: 50%;
            width: 70px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            font-size: 3rem;
        }

        .card-label {
            font-weight: 700;
            font-size: 1rem;
            text-transform: uppercase;
            text-align: center;
            line-height: 1.1;
        }

        /* BUTTONS */
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.4rem;
            font-family: var(--font-head);
            text-transform: uppercase;
            border-radius: 50px;
            box-shadow: 0 5px 0 rgba(0, 0, 0, 0.2);
            cursor: pointer;
            width: 80%;
            max-width: 400px;
            margin: 20px auto;
            display: block;
            transition: transform 0.1s;
        }

        .btn:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 rgba(0, 0, 0, 0.2);
        }

        /* SETUP */
        .setup-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            width: 100%;
            justify-content: center;
        }

        .setup-col {
            flex: 1 1 300px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 15px;
        }

        .setup-col h3 {
            color: var(--secondary);
            text-align: left;
            margin-left: 10px;
        }

        /* ANIMATIONS */
        @keyframes twinkle {

            0%,
            100% {
                opacity: 0.5;
            }

            50% {
                opacity: 1;
            }
        }

        @keyframes waves {
            0% {
                background-position: 0 0;
            }

            100% {
                background-position: 60px 0;
            }
        }

        @keyframes boom {
            0% {
                transform: scale(1);
            }

            100% {
                transform: scale(1.1);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeUp {
            0% {
                opacity: 1;
                transform: translateY(0);
            }

            100% {
                opacity: 0;
                transform: translateY(-60px);
            }
        }

        /* UTIL */
        .hidden {
            display: none !important;
        }

        .message-area {
            font-size: 1.3rem;
            margin: 10px;
            text-align: center;
            color: var(--accent);
            font-weight: bold;
            min-height: 1.5em;
        }

        .big-icon {
            font-size: 6rem;
            margin: 20px;
            animation: bounce 2s infinite;
        }

        /* SETUP MISSION BOARD */
        .mission-board {
            display: flex;
            gap: 20px;
            width: 100%;
            height: 60vh;
            min-height: 400px;
        }

        .mission-timeline {
            flex: 1;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 20px;
            padding: 15px;
            overflow-y: auto;
            border: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: 250px;
        }

        .mission-editor {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
        }

        /* Responsive Mobile Fix */
        @media (max-width: 768px) {
            .mission-board {
                flex-direction: column;
                height: auto;
                min-height: 100%;
            }

            .mission-timeline {
                flex: none;
                height: auto;
                min-width: 100%;
            }

            .mission-editor {
                flex: 1;
                min-height: 400px;
            }

            #screen-setup {
                overflow-y: auto;
                padding-top: 80px;
            }

            /* Mobile Button improvements */
            .phase-controls {
                gap: 10px;
            }

            .ctrl-btn {
                padding: 12px 15px;
                /* Larger touch target */
                font-size: 1.3rem;
                background: rgba(255, 255, 255, 0.2);
                /* More visible */
                margin-left: 5px;
                border-radius: 8px;
                /* Softer edges */
            }
        }

        .phase-card {
            background: var(--glass);
            border-radius: 15px;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s;
            border: 1px solid transparent;
            cursor: grab;
        }

        .phase-card:active {
            cursor: grabbing;
        }

        .phase-card.active-edit {
            border-color: var(--accent);
            background: rgba(255, 217, 61, 0.1);
        }

        .phase-card.dragging {
            opacity: 0.5;
            border: 2px dashed #FFD700;
        }

        .phase-card.drag-over {
            border-top: 2px solid #FFD700;
        }

        .phase-card.disabled {
            opacity: 0.5;
            background: rgba(0, 0, 0, 0.1);
        }

        .phase-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: var(--font-head);
            font-size: 1.1rem;
        }

        .phase-controls {
            display: flex;
            gap: 5px;
        }

        .ctrl-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
        }

        .ctrl-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .ctrl-btn.active {
            color: var(--success);
        }

        .editor-header {
            font-family: var(--font-head);
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--secondary);
            border-bottom: 2px solid var(--glass-border);
            padding-bottom: 10px;
        }

        .editor-grid {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-15px);
            }
        }
    </style>
</head>

<body class="theme-space"> <!-- Default Theme -->

    <div class="bg-overlay"></div>

    <header id="main-header" class="hidden">
        <h1 class="main-title" id="header-title">MI AVENTURA</h1>
        <div class="score-board">
            <span id="score-icon">‚≠ê</span>
            <span id="score-display">0</span>
        </div>
    </header>

    <!-- 1. ADVENTURE SELECTOR -->
    <section id="screen-adventure" class="screen active">
        <h1 class="main-title" style="font-size: 2.2rem; margin-top: 30px;">ELIGE TU MISI√ìN</h1>

        <div style="display: flex; flex-wrap: wrap; justify-content: center; width: 100%; max-width: 800px; gap: 10px;">
            <!-- ORIGINAL -->
            <div class="adventure-card card-space" onclick="selectAdventure('SPACE')">
                <div class="adventure-icon">üöÄ</div>
                <div class="adventure-title">ESPACIO</div>
                <div class="adventure-desc">Convi√©rtete en astronauta</div>
            </div>
            <div class="adventure-card card-forest" onclick="selectAdventure('FOREST')">
                <div class="adventure-icon">üå≤</div>
                <div class="adventure-title">BOSQUE</div>
                <div class="adventure-desc">Explora la naturaleza</div>
            </div>
            <div class="adventure-card card-pirate" onclick="selectAdventure('PIRATE')">
                <div class="adventure-icon">üè¥‚Äç‚ò†Ô∏è</div>
                <div class="adventure-title">PIRATAS</div>
                <div class="adventure-desc">Busca el tesoro</div>
            </div>

            <!-- NEW -->
            <div class="adventure-card card-jungle" onclick="selectAdventure('JUNGLE')">
                <div class="adventure-icon">ü¶Å</div>
                <div class="adventure-title">SELVA</div>
                <div class="adventure-desc">Explora la selva</div>
            </div>
            <div class="adventure-card card-dino" onclick="selectAdventure('DINO')">
                <div class="adventure-icon">ü¶ñ</div>
                <div class="adventure-title">DINOS</div>
                <div class="adventure-desc">Mundo Jur√°sico</div>
            </div>
            <div class="adventure-card card-racing" onclick="selectAdventure('RACING')">
                <div class="adventure-icon">üèéÔ∏è</div>
                <div class="adventure-title">CARRERAS</div>
                <div class="adventure-desc">Gran Premio</div>
            </div>
            <div class="adventure-card card-hero" onclick="selectAdventure('HERO')">
                <div class="adventure-icon">ü¶∏</div>
                <div class="adventure-title">H√âROE</div>
                <div class="adventure-desc">Salvar el mundo</div>
            </div>
        </div>
    </section>

    <!-- 2. SETUP PHASE (MISSION BOARD) -->
    <section id="screen-setup" class="screen">
        <h2 id="setup-title">PLAN DE MISI√ìN</h2>
        <p style="text-align:center; opacity:0.8; margin-top:-10px;">Configura tu rutina paso a paso</p>

        <div class="mission-board">
            <!-- LEFT: TIMELINE -->
            <div class="mission-timeline" id="mission-timeline">
                <!-- Phases injected by JS -->
            </div>

            <!-- RIGHT: EDITOR -->
            <div class="mission-editor">
                <div class="editor-header" id="editor-title">SELECCIONA UNA FASE</div>
                <div class="grid-container editor-grid" id="editor-grid">
                    <p style="text-align:center; width:100%; margin-top:50px; opacity:0.5;">
                        üëà Toca el l√°piz en una fase para editar sus objetos
                    </p>
                </div>
            </div>
        </div>

        <button class="btn" onclick="startGame()">¬°COMENZAR!</button>
    </section>

    <!-- 3. TIDY PHASE -->
    <section id="screen-tidy" class="screen">
        <h2 id="tidy-title">FASE 1: ORDENAR</h2>
        <div class="message-area" id="tidy-msg">Mensaje de orden</div>
        <div class="grid-container" id="tidy-grid"></div>
    </section>

    <!-- 4. BREAKFAST PHASE -->
    <section id="screen-breakfast" class="screen">
        <h2 id="breakfast-title">FASE 2: DESAYUNO</h2>
        <div class="message-area" id="breakfast-msg">Mensaje de desayuno</div>
        <div class="grid-container" id="breakfast-grid"></div>
    </section>

    <!-- 5. TEETH PHASE -->
    <section id="screen-teeth" class="screen">
        <h2 id="teeth-title">FASE 3: DIENTES</h2>
        <div class="message-area" id="teeth-msg">Mensaje de dientes</div>
        <div class="grid-container" id="teeth-grid"></div>
    </section>

    <!-- 6. UNDRESS PHASE -->
    <section id="screen-undress" class="screen">
        <h2 id="undress-title">FASE 4: QUITARSE</h2>
        <div class="message-area" id="undress-msg">Mensaje de quitarse</div>
        <div class="grid-container" id="undress-grid"></div>
    </section>

    <!-- 7. DRESS PHASE -->
    <section id="screen-dress" class="screen">
        <h2 id="dress-title">FASE 5: PONERSE</h2>
        <div class="message-area" id="dress-msg">Mensaje de ponerse</div>
        <div class="grid-container" id="dress-grid"></div>
    </section>

    <!-- 8. BACKPACK PHASE -->
    <section id="screen-backpack" class="screen">
        <h2 id="backpack-title">FASE 6: MOCHILA</h2>
        <div class="message-area" id="backpack-msg">Mensaje de mochila</div>
        <div class="grid-container" id="backpack-grid"></div>
    </section>

    <!-- 5. SUCCESS PHASE -->
    <section id="screen-success" class="screen">
        <h1 style="color:var(--success); font-size: 2.5rem; margin-top: 40px;">¬°COMPLETADO!</h1>
        <div class="big-icon" id="success-icon">üèÜ</div>
        <div style="font-size: 3rem; color: var(--accent); padding: 20px;" id="final-score">0 PUNTOS</div>
        <p style="font-size: 1.4rem;" id="success-msg">¬°Gran trabajo!</p>
        <button class="btn" onclick="location.reload()">Jugar de Nuevo</button>
    </section>

    <canvas id="confetti"
        style="position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:100;"></canvas>

    <script>
        // --- DATA ---
        const catalog = [
            // ROPA / UNDRESS / DRESS
            { id: 'calzoncillos', name: 'Calzoncillos', icon: 'ü©≤', type: 'clothes' },
            { id: 'braguitas', name: 'Braguitas', icon: 'ü©≤', type: 'clothes' },
            { id: 'calcetines', name: 'Calcetines', icon: 'üß¶', type: 'clothes' },
            { id: 'camiseta', name: 'Camiseta', icon: 'üëï', type: 'clothes' },
            { id: 'pantalon', name: 'Pantal√≥n', icon: 'üëñ', type: 'clothes' },
            { id: 'zapatos', name: 'Zapatos', icon: 'üëü', type: 'clothes' },
            { id: 'zapatillas', name: 'Zapatillas', icon: 'üëü', type: 'clothes' },
            { id: 'chaqueta', name: 'Chaqueta', icon: 'üß•', type: 'clothes' },
            { id: 'jersey', name: 'Jersey', icon: 'üß•', type: 'clothes' },
            { id: 'pijama_camiseta', name: 'Camiseta Pijama', icon: 'üëï', type: 'clothes' },
            { id: 'pijama_pantalon', name: 'Pantal√≥n Pijama', icon: 'ü©≥', type: 'clothes' },
            { id: 'pijama', name: 'Pijama Entero', icon: 'üëò', type: 'clothes' },
            { id: 'vestido', name: 'Vestido', icon: 'üëó', type: 'clothes' },
            { id: 'abrigo', name: 'Abrigo', icon: 'üß•', type: 'clothes' },
            { id: 'gorro', name: 'Gorro', icon: 'üß¢', type: 'clothes' },
            { id: 'bufanda', name: 'Bufanda', icon: 'üß£', type: 'clothes' },

            // HABITACI√ìN / TIDY
            { id: 'hacer_cama', name: 'Hacer Cama', icon: 'üõèÔ∏è', type: 'tidy' },
            { id: 'recoger_juguetes', name: 'Juguetes', icon: 'üß∏', type: 'tidy' },
            { id: 'guardar_pijama', name: 'Guardar Pijama', icon: 'üëö', type: 'tidy' },
            { id: 'abrir_persiana', name: 'Abrir Persiana', icon: '‚òÄÔ∏è', type: 'tidy' },
            { id: 'ropa_sucia', name: 'Ropa Sucia', icon: 'üß∫', type: 'tidy' },
            { id: 'regar_plantas', name: 'Regar Plantas', icon: 'ü™¥', type: 'tidy' },

            // DESAYUNO / BREAKFAST
            { id: 'leche', name: 'Leche', icon: 'ü•õ', type: 'breakfast' },
            { id: 'tostadas', name: 'Tostadas', icon: 'üçû', type: 'breakfast' },
            { id: 'cereales', name: 'Cereales', icon: 'ü•£', type: 'breakfast' },
            { id: 'fruta', name: 'Fruta', icon: 'üçé', type: 'breakfast' },
            { id: 'zumo', name: 'Zumo', icon: 'üßÉ', type: 'breakfast' },
            { id: 'galletas', name: 'Galletas', icon: 'üç™', type: 'breakfast' },
            { id: 'yogur', name: 'Yogur', icon: 'üç¶', type: 'breakfast' },
            { id: 'huevo', name: 'Huevo', icon: 'ü•ö', type: 'breakfast' },
            { id: 'sandwich', name: 'Sandwich', icon: 'ü•™', type: 'breakfast' },
            { id: 'cubiertos', name: 'Cubiertos', icon: 'üç¥', type: 'breakfast' },
            { id: 'servilleta', name: 'Servilleta', icon: 'üßª', type: 'breakfast' },

            // DIENTES / TEETH
            { id: 'cepillo', name: 'Cepillo', icon: 'ü™•', type: 'teeth' },
            { id: 'pasta', name: 'Pasta', icon: 'üß¥', type: 'teeth' },
            { id: 'lavar_cara', name: 'Lavar Cara', icon: 'üíß', type: 'teeth' },
            { id: 'peine', name: 'Peinarse', icon: 'üíÜ', type: 'teeth' },
            { id: 'colonia', name: 'Colonia', icon: '‚ú®', type: 'teeth' },
            { id: 'toalla', name: 'Toalla', icon: 'üßñ', type: 'teeth' },
            { id: 'hilo_dental', name: 'Hilo Dental', icon: 'üßµ', type: 'teeth' },

            // MOCHILA / BACKPACK
            { id: 'agua', name: 'Agua', icon: 'üíß', type: 'backpack' },
            { id: 'almuerzo', name: 'Almuerzo', icon: 'ü•™', type: 'backpack' },
            { id: 'agenda', name: 'Agenda', icon: 'üìì', type: 'backpack' },
            { id: 'libros', name: 'Libros', icon: 'üìö', type: 'backpack' },
            { id: 'estuche', name: 'Estuche', icon: '‚úèÔ∏è', type: 'backpack' },
            { id: 'juguete_cole', name: 'Juguete Cole', icon: 'üéÆ', type: 'backpack' },
            { id: 'mochila_deporte', name: 'Mochila Deporte', icon: 'üéæ', type: 'backpack' },
            { id: 'crema_sol', name: 'Crema Sol', icon: 'üß¥', type: 'backpack' },
            { id: 'gorra', name: 'Gorra', icon: 'üß¢', type: 'backpack' }
        ];

        // --- THEME CONFIG (EXTENDED) ---
        const THEMES = {
            SPACE: {
                class: 'theme-space',
                title: 'MISI√ìN ESPACIAL',
                icon: 'üöÄ',
                scoreIcon: '‚≠ê',
                texts: {
                    setup: 'CONFIGURAR NAVE',
                    undressTitle: 'DESPEGUE (Quitando Traje)',
                    dressTitle: 'TRAJE ESPACIAL',
                    tidyTitle: 'MANTENIMIENTO NAVE',
                    breakfastTitle: 'COMBUSTIBLE',
                    teethTitle: 'LIMPIEZA SENSORES',
                    backpackTitle: 'KIT DE SUPERVIVENCIA',

                    undressMsg: 'Qu√≠tate la ropa terrestre para despegar.',
                    dressMsg: 'Ponte tu traje espacial de hoy.',
                    tidyMsg: 'Prepara la cabina para el lanzamiento.',
                    breakfastMsg: 'Recarga energ√≠a para el viaje.',
                    teethMsg: 'Limpia los sensores de comunicaci√≥n.',
                    backpackMsg: 'Carga los suministros en la nave.',

                    successMsg: '¬°Misi√≥n cumplida, Comandante!',
                    successIcon: 'ü™ê'
                }
            },
            FOREST: {
                class: 'theme-forest',
                title: 'AVENTURA BOSQUE',
                icon: 'üå≤',
                scoreIcon: 'üçÇ',
                texts: {
                    setup: 'PREPARAR VIAJE',
                    undressTitle: 'SALIR DEL SACO',
                    dressTitle: 'ROPA DE CAMPO',
                    tidyTitle: 'LIMPIAR CAMPAMENTO',
                    breakfastTitle: 'COMIDA DEL BOSQUE',
                    teethTitle: 'LAVARSE EN EL R√çO',
                    backpackTitle: 'MOCHILA EXPLORADOR',

                    undressMsg: 'Qu√≠tate el pijama, ¬°el sol ya sali√≥!',
                    dressMsg: 'V√≠stete para explorar el bosque.',
                    tidyMsg: 'Deja el campamento ordenado.',
                    breakfastMsg: 'Desayuna fuerte para la caminata.',
                    teethMsg: 'L√°vate con el agua fresca del r√≠o.',
                    backpackMsg: 'Prepara todo para la excursi√≥n.',

                    successMsg: '¬°Has encontrado el √°rbol sabio!',
                    successIcon: '‚õ∫'
                }
            },
            PIRATE: {
                class: 'theme-pirate',
                title: 'TESORO PIRATA',
                icon: 'üè¥‚Äç‚ò†Ô∏è',
                scoreIcon: 'üí∞',
                texts: {
                    setup: 'MISI√ìN CAPIT√ÅN',
                    undressTitle: 'LEVAR ANCLAS',
                    dressTitle: 'TRAJE DE PIRATA',
                    tidyTitle: 'LIMPIAR CUBIERTA',
                    breakfastTitle: 'RON Y GALLETAS',
                    teethTitle: 'DIENTES BRILLANTES',
                    backpackTitle: 'SACO DEL TESORO',

                    undressMsg: '¬°Fuera ropa de grumete, a navegar!',
                    dressMsg: '¬°Ponte tu ropa de Capit√°n!',
                    tidyMsg: '¬°A fregar la cubierta, marineros!',
                    breakfastMsg: 'Come antes de buscar el tesoro.',
                    teethMsg: '¬°Esos dientes tienen que brillar como el oro!',
                    backpackMsg: 'Guarda lo necesario en el cofre.',

                    successMsg: '¬°Tesoro encontrado! ¬°Rey del mar!',
                    successIcon: 'üíé'
                }
            },
            JUNGLE: {
                class: 'theme-jungle',
                title: 'EXPEDICI√ìN SELVA',
                icon: 'ü¶Å',
                scoreIcon: 'üçå',
                texts: {
                    setup: 'PLAN DE SAFARI',
                    undressTitle: 'DESPERTAR EN LA SELVA',
                    dressTitle: 'ROPA DE CAMUFLAJE',
                    tidyTitle: 'ORDENAR TIENDA',
                    breakfastTitle: 'FRUTOS TROPICALES',
                    teethTitle: 'SONRISA SALVAJE',
                    backpackTitle: 'EQUIPO DE RASTREO',

                    undressMsg: 'Qu√≠tate la ropa de dormir.',
                    dressMsg: 'V√≠stete para ver a los leones.',
                    tidyMsg: 'Deja la tienda lista para volver.',
                    breakfastMsg: 'Come fruta para tener fuerza.',
                    teethMsg: 'L√°vate para rugir mejor.',
                    backpackMsg: 'Prepara el equipo de investigaci√≥n.',

                    successMsg: '¬°Eres el Rey de la Selva!',
                    successIcon: 'üêæ'
                }
            },
            DINO: {
                class: 'theme-dino',
                title: 'MUNDO JUR√ÅSICO',
                icon: 'ü¶ñ',
                scoreIcon: 'ü¶¥',
                texts: {
                    setup: 'BASE JUR√ÅSICA',
                    undressTitle: 'ESCAPAR DE LA CUEVA',
                    dressTitle: 'PIEL DE DINOSAURIO',
                    tidyTitle: 'ORDENAR NIDO',
                    breakfastTitle: 'COMIDA HERB√çVORA',
                    teethTitle: 'DIENTES DE T-REX',
                    backpackTitle: 'KIT DE F√ìSILES',

                    undressMsg: '¬°Sal del nido, peque√±o dino!',
                    dressMsg: 'Ponte tu equipo de paleont√≥logo.',
                    tidyMsg: 'Deja el nido limpio y ordenado.',
                    breakfastMsg: 'Come hojas y agua fresca.',
                    teethMsg: '¬°Afila esos dientes!',
                    backpackMsg: 'Lleva tus herramientas de excavaci√≥n.',

                    successMsg: '¬°Has descubierto un T-REX!',
                    successIcon: 'üåã'
                }
            },
            RACING: {
                class: 'theme-racing',
                title: 'GRAN PREMIO',
                icon: 'üèéÔ∏è',
                scoreIcon: 'üèÅ',
                texts: {
                    setup: 'TALLER',
                    undressTitle: 'CAMBIO DE RUEDAS',
                    dressTitle: 'MONO DE PILOTO',
                    tidyTitle: 'LIMPIAR TALLER',
                    breakfastTitle: 'GASOLINA SUPER',
                    teethTitle: 'PULIR CARROCER√çA',
                    backpackTitle: 'CAJA DE HERRAMIENTAS',

                    undressMsg: 'C√°mbiate r√°pido, ¬°el equipo te espera!',
                    dressMsg: 'Ponte el traje ign√≠fugo de piloto.',
                    tidyMsg: 'Deja el taller impecable.',
                    breakfastMsg: 'Llena el dep√≥sito a tope.',
                    teethMsg: 'Saca brillo a esa sonrisa.',
                    backpackMsg: 'Prepara las herramientas para la carrera.',

                    successMsg: '¬°Pole Position! ¬°Campe√≥n!',
                    successIcon: 'üèÜ'
                }
            },
            HERO: {
                class: 'theme-hero',
                title: 'SUPER H√âROES',
                icon: 'ü¶∏',
                scoreIcon: '‚ö°',
                texts: {
                    setup: 'LA BATCUEVA',
                    undressTitle: 'IDENTIDAD SECRETA',
                    dressTitle: 'SUPERTRAJE',
                    tidyTitle: 'ORDENAR GUARIDA',
                    breakfastTitle: 'SUPER VITAMINAS',
                    teethTitle: 'RAYOS LIMPIADORES',
                    backpackTitle: 'GADGETS',

                    undressMsg: 'Deja tu ropa de civil.',
                    dressMsg: '¬°Ponte tu capa y salva la ciudad!',
                    tidyMsg: 'Mant√©n secreta tu guarida.',
                    breakfastMsg: 'Toma tus superalimentos.',
                    teethMsg: '¬°Sonrisa deslumbrante activada!',
                    backpackMsg: 'Carga tus gadgets secretos.',

                    successMsg: '¬°La ciudad est√° a salvo gracias a ti!',
                    successIcon: 'üí•'
                }
            }
        };

        // --- STATE ---
        // Defaults
        let selectedTidy = new Set(['hacer_cama', 'abrir_persiana']);
        let selectedBreakfast = new Set(['leche', 'cereales']);
        let selectedTeeth = new Set(['cepillo', 'pasta', 'lavar_cara']);
        let selectedUndress = new Set(['pijama_camiseta', 'pijama_pantalon']);
        let selectedDress = new Set(['calzoncillos', 'camiseta', 'pantalon']);
        let selectedBackpack = new Set(['agua', 'almuerzo']);

        // New State for flexible flow
        let routineOrder = ['TIDY', 'BREAKFAST', 'TEETH', 'UNDRESS', 'DRESS', 'BACKPACK'];
        let activePhases = new Set(['TIDY', 'BREAKFAST', 'TEETH', 'UNDRESS', 'DRESS', 'BACKPACK']);
        let editingPhase = null; // Currently editing this phase in Setup

        let state = {
            phase: 'ADVENTURE_SELECT',
            tidyProgress: new Set(),
            breakfastProgress: new Set(),
            teethProgress: new Set(),
            undressProgress: new Set(),
            dressProgress: new Set(),
            backpackProgress: new Set(),
            score: 0,
            theme: 'SPACE'
        };

        // Helpers to map Phase ID to Set and Props
        const PHASE_MAP = {
            'TIDY': { set: selectedTidy, icon: 'üõèÔ∏è', label: 'Habitaci√≥n', dataId: 'tidy' },
            'BREAKFAST': { set: selectedBreakfast, icon: 'ü•£', label: 'Desayuno', dataId: 'breakfast' },
            'TEETH': { set: selectedTeeth, icon: 'ü™•', label: 'Aseo', dataId: 'teeth' },
            'UNDRESS': { set: selectedUndress, icon: 'üîª', label: 'Quitarse', dataId: 'clothes' },
            'DRESS': { set: selectedDress, icon: 'üî∫', label: 'Ponerse', dataId: 'clothes' },
            'BACKPACK': { set: selectedBackpack, icon: 'üéí', label: 'Mochila', dataId: 'backpack' }
        };

        // --- FUNCTIONS ---

        function selectAdventure(themeKey) {
            state.theme = themeKey;
            const config = THEMES[themeKey];

            // Apply Theme Class
            document.body.className = config.class;

            // Update Static Texts
            document.getElementById('header-title').innerText = config.title;
            document.getElementById('score-icon').innerText = config.scoreIcon;

            // Setup title might be constant now, or theme flavor
            // document.getElementById('setup-title').innerText = config.texts.setup; 

            document.getElementById('tidy-title').innerText = config.texts.tidyTitle;
            document.getElementById('breakfast-title').innerText = config.texts.breakfastTitle;
            document.getElementById('teeth-title').innerText = config.texts.teethTitle;
            document.getElementById('undress-title').innerText = config.texts.undressTitle;
            document.getElementById('dress-title').innerText = config.texts.dressTitle;
            document.getElementById('backpack-title').innerText = config.texts.backpackTitle;

            document.getElementById('tidy-msg').innerText = config.texts.tidyMsg;
            document.getElementById('breakfast-msg').innerText = config.texts.breakfastMsg;
            document.getElementById('teeth-msg').innerText = config.texts.teethMsg;
            document.getElementById('undress-msg').innerText = config.texts.undressMsg;
            document.getElementById('dress-msg').innerText = config.texts.dressMsg;
            document.getElementById('backpack-msg').innerText = config.texts.backpackMsg;

            document.getElementById('success-msg').innerText = config.texts.successMsg;
            document.getElementById('success-icon').innerText = config.texts.successIcon;

            // Show Header
            document.getElementById('main-header').classList.remove('hidden');

            switchPhase('SETUP');
        }

        function createCard(item, onClick, isSelected, isSetup, isDone) {
            const div = document.createElement('div');
            div.className = `card ${isSelected ? 'selected' : ''} ${isDone ? 'done' : ''}`;

            if (isSetup) {
                div.onclick = () => { onClick(item); };
            } else {
                div.onclick = (e) => {
                    if (!isDone) onClick(item, e.clientX, e.clientY);
                };
            }

            div.innerHTML = `
            <div class="icon-circle">${item.icon}</div>
            <div class="card-label">${item.name}</div>
        `;
            return div;
        }

        // --- MISSION BOARD LOGIC ---

        function renderSetup() {
            const container = document.getElementById('mission-timeline');
            container.innerHTML = '';

            routineOrder.forEach((phaseId, index) => {
                const info = PHASE_MAP[phaseId];
                const isActive = activePhases.has(phaseId);
                const isEditing = editingPhase === phaseId;

                const card = document.createElement('div');
                card.className = `phase-card ${isActive ? '' : 'disabled'} ${isEditing ? 'active-edit' : ''}`;

                // DRAG AND DROP ATTRIBUTES
                card.draggable = true;
                card.dataset.index = index;

                // Add DnD Listeners
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragover', handleDragOver);
                card.addEventListener('drop', handleDrop);
                card.addEventListener('dragenter', handleDragEnter);
                card.addEventListener('dragleave', handleDragLeave);

                // HTML structure for the card
                card.innerHTML = `
                    <div class="phase-info" style="pointer-events: none;">
                        <span>${index + 1}.</span>
                        <span style="font-size:1.5rem">${info.icon}</span>
                        <span>${info.label} (${info.set.size})</span>
                    </div>
                    <div class="phase-controls">
                        <button class="ctrl-btn" onclick="movePhase(${index}, -1)">‚¨ÜÔ∏è</button>
                        <button class="ctrl-btn" onclick="movePhase(${index}, 1)">‚¨áÔ∏è</button>
                        <button class="ctrl-btn" onclick="togglePhase('${phaseId}')">${isActive ? '‚úÖ' : '‚ùå'}</button>
                        <button class="ctrl-btn ${isEditing ? 'active' : ''}" onclick="editPhase('${phaseId}')">‚úèÔ∏è</button>
                    </div>
                `;
                container.appendChild(card);
            });

            // If we are editing a phase, render its grid
            if (editingPhase && activePhases.has(editingPhase)) {
                renderEditorGrid();
            } else {
                // If disabled or null, clear grid
                document.getElementById('editor-grid').innerHTML = '<p style="text-align:center; width:100%; margin-top:50px; opacity:0.5;">üëà Selecciona ‚úèÔ∏è para editar</p>';
                document.getElementById('editor-title').innerText = "PLANIFICADOR";
            }
        }

        // DnD Handlers
        let dragSrcIndex = null;

        function handleDragStart(e) {
            this.style.opacity = '0.4';
            dragSrcIndex = Number(this.dataset.index);
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', dragSrcIndex);
            this.classList.add('dragging');
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault(); // Necessary. Allows us to drop.
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            this.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation(); // stops the browser from redirecting.
            }

            const targetIndex = Number(this.dataset.index);

            // Don't do anything if dropping the same column we're dragging.
            if (dragSrcIndex !== null && dragSrcIndex !== targetIndex) {
                // Reorder array
                const movedItem = routineOrder[dragSrcIndex];
                routineOrder.splice(dragSrcIndex, 1); // Remove
                routineOrder.splice(targetIndex, 0, movedItem); // Insert at new

                renderSetup();
            }

            // Cleanup styles
            document.querySelectorAll('.phase-card').forEach(col => {
                col.classList.remove('drag-over');
                col.classList.remove('dragging');
                col.style.opacity = '1';
            });

            return false;
        }

        function movePhase(index, direction) {
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= routineOrder.length) return;

            // Swap
            const temp = routineOrder[index];
            routineOrder[index] = routineOrder[newIndex];
            routineOrder[newIndex] = temp;

            renderSetup();
        }

        function togglePhase(phaseId) {
            if (activePhases.has(phaseId)) {
                activePhases.delete(phaseId);
                if (editingPhase === phaseId) editingPhase = null;
            } else {
                activePhases.add(phaseId);
            }
            renderSetup();
        }

        function editPhase(phaseId) {
            if (!activePhases.has(phaseId)) return; // Can't edit disabled
            editingPhase = phaseId;
            renderSetup();
        }

        function renderEditorGrid() {
            const phaseId = editingPhase;
            const info = PHASE_MAP[phaseId];
            const grid = document.getElementById('editor-grid');
            const title = document.getElementById('editor-title');

            title.innerText = `EDITAR: ${info.label.toUpperCase()}`;
            grid.innerHTML = '';

            const typeFilter = info.dataId;
            const items = catalog.filter(i => i.type === typeFilter || (typeFilter === 'clothes' && i.type === 'clothes'));

            items.forEach(item => {
                const card = createCard(item, () => {
                    toggleSet(info.set, item.id);
                    renderSetup(); // Re-render to update counts and grid
                }, info.set.has(item.id), true, false);
                grid.appendChild(card);
            });
        }

        function toggleSet(set, id) {
            set.has(id) ? set.delete(id) : set.add(id);
        }

        // --- GAME LOGIC ---

        function renderGame(gridId, sourceSet, progressSet, handler) {
            const grid = document.getElementById(gridId);
            grid.innerHTML = '';

            Array.from(sourceSet).map(id => catalog.find(i => i.id === id)).forEach(item => {
                grid.appendChild(createCard(
                    item,
                    handler,
                    false,
                    false,
                    progressSet.has(item.id)
                ));
            });
        }

        function switchPhase(newPhase) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            state.phase = newPhase;

            // Helper to activate screen
            const s = (id) => document.getElementById(id).classList.add('active');

            if (newPhase === 'SETUP') {
                s('screen-setup');
                renderSetup();
            }
            else if (newPhase === 'SUCCESS') {
                s('screen-success');
                document.getElementById('final-score').innerText = state.score + " PUNTOS";
                startConfetti();
                speak(THEMES[state.theme].texts.successMsg);
            }
            else {
                // Generic handler for normal phases
                // We need to map Phase ID to Screen ID
                const screenId = 'screen-' + newPhase.toLowerCase();
                const gridId = newPhase.toLowerCase() + '-grid';
                const info = PHASE_MAP[newPhase];
                const set = info.set;
                const progress = state[newPhase.toLowerCase() + 'Progress'];
                // Careful: state property names matching? 
                // state.tidyProgress etc. yes.

                const el = document.getElementById(screenId);
                if (el) {
                    el.classList.add('active');
                    renderGame(gridId, set, progress, handleGameClick);

                    // Texts? 
                    // We need a map for texts too or dynamic property access
                    // THEMES[state.theme].texts.tidyMsg
                    // Let's create a key map
                    const msgKey = newPhase.toLowerCase() + 'Msg';
                    const msg = THEMES[state.theme].texts[msgKey];
                    if (msg) speak(msg);
                }
            }
        }

        function startGame() {
            // Reset Progress
            state.tidyProgress = new Set();
            state.breakfastProgress = new Set();
            state.teethProgress = new Set();
            state.undressProgress = new Set();
            state.dressProgress = new Set();
            state.backpackProgress = new Set();

            state.score = 0;
            document.getElementById('score-display').innerText = '0';

            // Find first phase
            advancePhase();
        }

        function advancePhase() {
            // Priority Order: Based on routineOrder and activePhases

            const currentPhase = state.phase;

            // Find index of current phase in routineOrder
            let currentIndex = -1;
            if (currentPhase !== 'SETUP' && currentPhase !== 'ADVENTURE_SELECT') {
                currentIndex = routineOrder.indexOf(currentPhase);
            }

            // Find next active phase with items
            for (let i = currentIndex + 1; i < routineOrder.length; i++) {
                const pId = routineOrder[i];
                if (activePhases.has(pId)) {
                    if (PHASE_MAP[pId].set.size > 0) {
                        return switchPhase(pId);
                    }
                }
            }

            switchPhase('SUCCESS');
        }

        function handleGameClick(item, x, y) {
            // Dynamic resolution
            // state.phase is like 'TIDY'
            const info = PHASE_MAP[state.phase];
            const sourceSet = info.set;
            const progressSet = state[state.phase.toLowerCase() + 'Progress'];

            if (!progressSet.has(item.id)) {
                progressSet.add(item.id);
                addScore(100, x, y);

                renderGame(state.phase.toLowerCase() + '-grid', sourceSet, progressSet, handleGameClick);
                checkPhaseComplete();
            }
        }

        function addScore(amount, x, y) {
            state.score += amount;
            document.getElementById('score-display').innerText = state.score;

            const pop = document.createElement('div');
            pop.className = 'points-pop';
            pop.innerText = `+${amount}`;
            pop.style.left = (x || window.innerWidth / 2) + 'px';
            pop.style.top = (y || window.innerHeight / 2) + 'px';
            document.body.appendChild(pop);
            setTimeout(() => pop.remove(), 800);

            if (navigator.vibrate) navigator.vibrate(20);
        }

        function checkPhaseComplete() {
            // Dynamic check
            const info = PHASE_MAP[state.phase];
            const sourceSet = info.set;
            const progressSet = state[state.phase.toLowerCase() + 'Progress'];

            if (progressSet.size >= sourceSet.size) {
                setTimeout(() => {
                    advancePhase();
                }, 1000);
            }
        }

        function speak(text) {
            if ('speechSynthesis' in window) {
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'es-ES';
                window.speechSynthesis.speak(u);
            }
        }

        // --- CONFETTI ---
        function startConfetti() {
            const canvas = document.getElementById('confetti');
            const ctx = canvas.getContext('2d');

            // Resize canvas
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const colors = state.theme === 'FOREST' ? ['#66BB6A', '#FFA726', '#FFEB3B']
                : state.theme === 'PIRATE' ? ['#FFD700', '#D32F2F', '#FFFFFF']
                    : state.theme === 'JUNGLE' ? ['#ffab00', '#64dd17', '#ffd600']
                        : state.theme === 'DINO' ? ['#ff5722', '#8d6e63', '#ffcc80']
                            : state.theme === 'RACING' ? ['#d50000', '#000000', '#ffffff']
                                : ['#F72585', '#4CC9F0', '#FFD93D']; // Space/Hero/Default

            const particles = Array.from({ length: 100 }, () => ({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height - canvas.height,
                size: Math.random() * 8 + 4,
                color: colors[Math.floor(Math.random() * colors.length)],
                speed: Math.random() * 5 + 2
            }));

            function loop() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                particles.forEach(p => {
                    p.y += p.speed;
                    if (p.y > canvas.height) p.y = -10;
                    ctx.fillStyle = p.color;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    ctx.fill();
                });
                requestAnimationFrame(loop);
            }
            loop();
        }

    </script>
</body>

</html>
